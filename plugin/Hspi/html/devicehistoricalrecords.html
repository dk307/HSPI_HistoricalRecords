<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!--Don't cache anything-->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

	
    {{includefile '/bootstrap/css/page_common.css'}}
    <title>Historical Records</title>
	
	<style>
		canvas {
			 width: 100%;  
			 object-fit: contain; 
		}

		.chart-container {
		  position: relative;
		  margin: auto;	
		  height: 60vh;
		}
	</style>
	
    <link href="/css/hs.css" rel="stylesheet">
    <link rel="stylesheet" href="/bootstrap/css/addons/datatables.min.css" />
    <link rel="stylesheet" href="/bootstrap/css/addons/datatables-select.min.css" />
    <link rel="stylesheet" href="/HistoricalRecords/dataTables.bootstrap4.min.css" />
</head>

{{
	refId=queries['ref'] ?? ""
	featureId=queries['feature'] ?? refId
	displaySelect=queries['displaySelect'] ?? ""
	displayMin=queries['displayMin'] ?? ""
	displayMax=queries['displayMax'] ?? ""
	displayPeriod=queries['displayPeriod'] ?? ""
	
	# get list of features for devices
	childrenRefIds=plugin_function 'HistoricalRecords' 'GetFeatureRefIdsForDevice'[refId]
	
	deviceDisplayDetails=plugin_function 'HistoricalRecords' 'GetAllowedDisplays'[featureId]
	devicePageStats=plugin_function 'HistoricalRecords' 'GetDevicePageHeaderStats'[featureId]

	deviceDisplayDetails=deviceDisplayDetails ?? []
	devicePageStats=devicePageStats ?? [0,0,false,0,""]
	oldestRecordTimeSpan=devicePageStats[0]
	earliestRecordTimeSpan=devicePageStats[1]
	deviceTracked=devicePageStats[2]
	devicePrecision=devicePageStats[3]
	deviceUnits=devicePageStats[4] ?? ""
		
	if deviceDisplayDetails.empty? 
		# there is no valid displays
		displaySelect=""
	else if !(deviceDisplayDetails | array.contains displaySelect)
		# select default value to chart if current value is not select
		if deviceUnits != "" && (array.contains deviceDisplayDetails "chart")
			displaySelect="chart"
		else
			displaySelect="table"	
		end	
	end	 
	
	rangeOptions=[]	
	durationSeconds = ""
	if displaySelect != ""									 
		rangeOptionsForOthers=[ 
						 ["Last 6 hours", 21600, "6hr"],
						 ["Last 24 hours", 86400, "1d"],
						 ["Last 7 days", 604800, "7d"],
						 ["Last 30 days", 2592000, "30d"],
						 ["Last 90 days", 7776000, "90d"],
						 ["Last 180 days", 15552000, "180d"],
						 ["Last 365 days", 31536000, "365d"],
					 ]		 
					 			 
			

		for rangeOption in rangeOptionsForOthers
			if  rangeOption[1] <= oldestRecordTimeSpan
				rangeOptions = rangeOptions | array.add rangeOption
		 	else  
				# add one more after the limit
				rangeOptions = rangeOptions | array.add rangeOption
				break
			end
		end	
		
		rangeOptionFound = false
		for rangeOption in rangeOptions
			if rangeOption[2]==displayPeriod
				rangeOptionFound=true
				break
			end
		end

		if !rangeOptionFound
			# find the first option which would display some data
			for rangeOption in rangeOptions
				if rangeOption[1]>=earliestRecordTimeSpan
					displayPeriod=rangeOption[2]
					rangeOptionFound=true
					break
				end
			end	
		end	
		
		if !rangeOptionFound			
			displayPeriod=rangeOptions[0][2]
		end	
			
		for rangeOption in rangeOptions
			if  rangeOption[1] != "" && displayPeriod == rangeOption[2]
				durationSeconds=rangeOption[1]
				break
			end
		end							
	end
	
	show_refId=(get_setting_bool 'gEnableDeviceRefColumn') == 'checked'
}}	

<script>
{{ if durationSeconds != "" }}
const displayEndDate = 1000 * Math.round(Date.now() / 1000);
const displayStartDate = displayEndDate - {{durationSeconds}} * 1000;
{{else if displayMax != ""}}
const displayEndDate = new Date({{displayMax}} * 1000).getTime();
const displayStartDate = new Date({{displayMin}} * 1000).getTime();
{{end}}	

function getRangeString(min, max) {
	const minDateString = (new Date(min)).toLocaleString();
	const maxDateString = (new Date(max)).toLocaleString();
	return minDateString + " - " + maxDateString;
}
</script>
	
<body class="body homeseer-skin ml-0 mr-0" style="min-height: 3rem" aria-busy="true">	
<!-- refId={{refId}}<BR> -->
<!-- featureId={{featureId}}<BR> -->
<!-- deviceDisplayDetails={{deviceDisplayDetails}}<BR> -->
<!-- displaySelect={{displaySelect}}<BR> -->
<!-- displayMin={{displayMin}}<BR> -->
<!-- displayMax={{displayMax}}<BR> -->
<!-- displayPeriod={{displayPeriod}}<BR> -->
<!-- earliestRecordTimeSpan={{earliestRecordTimeSpan}}<BR> -->
<!-- oldestRecordTimeSpan={{oldestRecordTimeSpan}}<BR> -->
<!-- durationSeconds={{durationSeconds}}<BR> -->
<!-- deviceTracked={{deviceTracked}}<BR> -->
<!-- devicePrecision={{devicePrecision}}<BR> -->
<!-- deviceUnits={{deviceUnits}}<BR> -->
<!-- childrenRefIds={{childrenRefIds}}<BR> -->
 
<header>
	<nav class="navbar">
		<form class="form-inline my-0 mx-0" id="mainform" action="/HistoricalRecords/devicehistoricalrecords.html" method="GET" style="width:100%">	
			<input type="hidden" id="ref" name="ref" value="{{refId}}"> 
			<input type="hidden" id="displayMin" name="displayMin" value="{{displayMin}}"> 
			<input type="hidden" id="displayMax" name="displayMax" value="{{displayMax}}"> 
			<input type="hidden" id="displayLabel" name="displayLabel" value="{{displayLabel}}"> 

			
			{{if displaySelect != ""}}
			<div class="md-form my-0 mr-3" style="width:100%">
				<select id="feature" class="mdb-select md-form dropdown-primary colorful-select" name="feature" >
					{{for id in childrenRefIds}}
						<option value="{{id}}" {{if id==featureId}}selected{{end}} >{{device_name_full id  | html.escape}}{{if show_refId}}&nbsp;({{id}}){{end}}</option>	
					{{end}}			
				</select> 
				<label class="mdb-main-label" for="feature">Feature</label>
			</div>
			<div class="md-form my-0 mr-3">
				<select id="displaySelect" class="mdb-select md-form colorful-select" name="displaySelect">
					{{ for displayType in deviceDisplayDetails }}									
						<option value="{{displayType | html.escape}}" {{if displayType==displaySelect;}}selected{{end}}>
						{{
						case displayType
							when "table"
								"Table"
							when "chart"
								"Chart"
							when "stats"
								"Statistics"
						end														
						}}</option>								
					{{ end }}
				</select> 
				<label class="mdb-main-label" for="displaySelect">View Type</label>
			</div>	
				

			<div class="md-form my-0 mr-3">
				<select id="displayPeriod" class="mdb-select md-form colorful-select" name="displayPeriod">
					{{for rangeOption in rangeOptions}}
						<option value="{{rangeOption[2]}}" {{if rangeOption[2]==displayPeriod;}}selected{{end}}>{{rangeOption[0] | html.escape}}</option>	
					{{end}}			
				</select> 
				<label class="mdb-main-label" for="displayPeriod">Period</label>
			</div>
			<ul class="navbar-nav ml-auto nav-flex-icons nav-right"  >
			  <li class="nav-item">	  
				<a class="nav-link waves-effect waves-light " data-mdb-toggle="tooltip" title="Change tracking options for the device" id="idModalEditLink"  href="#">
				  <i class="fa fa-sliders-h"></i>
				</a>
			  </li>
			</ul>
			{{end}}		
		</form>
	</nav>	
</header>

<div class="container-fluid custom-scrollbar"> 
	<div class="hs_spinner" id="loading">
		<div class="hs_spinner d-flex justify-content-center align-items-center align-content-center">
			<div class="spinner-border" role="status">
				<span class="sr-only">Loading...</span>
			</div>
		</div>
	</div>	

	{{if displaySelect != ""}}
		{{			
			duration = ""		 
			for rangeOption in rangeOptions
				if rangeOption[2]==displayPeriod
					duration=rangeOption[1]
					break
				end
			end
		}}

		{{needDataTables=false}}
		{{if displaySelect=="table"}}
			<table id="dt-persistence" class="table table-sm mb-0 table-striped"  width="100%">	
				<thead>
					<tr>
						<th>Time</th>
						<th>Value{{if deviceUnits != ""}}({{deviceUnits}}){{end}}</th>
						<th>Status</th>						 
						<th>Duration</th>						 
					</tr>
				</thead>			
			</table>	
			{{needDataTables=true}}
		{{else if displaySelect=="chart"}}
			<div class="btn-group mt-2 mx-auto" role="group" aria-label="Graph options">
			  <button type="button" class="btn btn-info"  onclick="chartFunction(0)">Reset Zoom</button>

			  <div class="btn-group" role="group">
				<button id="btnGroupDropCurve" type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Curve</button>
				<div class="dropdown-menu" aria-labelledby="btnGroupDrop1">
				  <a class="dropdown-item"  onclick="chartFunction(1)">Step</a>
				  <a class="dropdown-item"  onclick="chartFunction(2)">Linear</a>
				</div>
			  </div>
			  <!-- <div class="btn-group" role="group"> -->
				<!-- <button id="btnGroupDropPoint" type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Point</button> -->
				<!-- <div class="dropdown-menu" aria-labelledby="btnGroupDrop1"> -->
				  <!-- <a class="dropdown-item" onclick="chartFunction(3)">None</a> -->
				  <!-- <a class="dropdown-item" onclick="chartFunction(4)">Circle</a> -->
				  <!-- <a class="dropdown-item" onclick="chartFunction(5)">Line</a> -->
				<!-- </div> -->
			  <!-- </div> -->
			</div>
			<div class="chart-container">
				<canvas id="myLineChart"></canvas>
			</div>
		{{else if displaySelect=="stats"}}
			<table id="dt-persistence" class="table table-sm mb-0 table-striped"  width="100%">	
				<thead style=" display:none;">
					<tr>
						<th>Type</th> 
						<th>Value</th> 
					</tr>
				</thead> 
			<table>		
			{{needDataTables=true}}		
		{{end}}		
	{{else if device}}
		Not Configured
	{{end}}
</div>

<div class="modal fade" id="modalEdit" tabindex="-1" role="dialog" aria-labelledby="lblModalEdit" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="lblModalEdit">Device Options</h5>
			</div>
			<div class="modal-body">
				<form>
					<input type="hidden" id="deviceOptionsRef" value="{{featureId}}"/>
					<div class="row mt-1 mb-1 no-gutters">
						<div class="form-check form-switch">
							<div class="form-check form-check-inline">
								<input type="checkbox" class="form-check-input" id="idTrackedFeature" name="idTrackedFeature" {{if deviceTracked}} checked {{end}}>
								<label class="form-check-label" for="idTrackedFeature">Track this device values</label>
							</div>            
						</div>
					</div>					 
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" id="btnOk">Save</button>
			</div>
		</div>
	</div>
</div>

{{includefile 'bootstrap/js/page_common.js'}}
<script type="text/javascript" src="/HistoricalRecords/iframeResizer.contentWindow.min.js"></script>

{{if needDataTables}}
<script type="text/javascript" src="/bootstrap/js/addons/datatables.min.js"></script>
<script type="text/javascript" src="/HistoricalRecords/humanize-duration.js"></script>
{{end}}

{{if displaySelect=="chart"}}
<script type="text/javascript" src="/HistoricalRecords/chart.min.js"></script>
<script type="text/javascript" src="/HistoricalRecords/moment.min.js"></script>
<script type="text/javascript" src="/HistoricalRecords/chartjs-adapter-moment.min.js"></script>
<script type="text/javascript" src="/HistoricalRecords/hammer.min.js"></script>
<script type="text/javascript" src="/HistoricalRecords/chartjs-plugin-zoom.min.js"></script>
{{end}}

<script type="text/javascript" src="/HistoricalRecords/historicalrecords.common.js"></script>

<script>
$(function() {
    $('#feature').change(function() {
        this.form.submit();
    });  

	$('#displaySelect').change(function() {
        this.form.submit();
    });	
	
	$('#displayPeriod').change(function() {
		if ($('#displayPeriod').val() == "customrange") {
			$('#modalRangeOptions').modal();
		} else {
			$('#displayMin').val('');
			$('#displayMax').val('');	
			this.form.submit();
		}
    });	
	
	 
	$('#idModalEditLink').click(function(){
		$('#modalEdit').modal('show');
	});
	
	$(document).on('click', '#btnOk', {}, async function (e) {
		$('#modalEdit').modal('hide');
		var data = {
			refId: $('#deviceOptionsRef').val(),
			tracked: (($('#idTrackedFeature').is(':checked')) ? 1 : 0),
		};
		await ajaxPostPlugIn("updatedevicesettings", data, null );
	});	 
});


function roundValue(num) {
	return Math.round(num * 10 ** {{devicePrecision}}) / 10 ** {{devicePrecision}};
}

{{if displaySelect=="table"}}

function humanizeTime(unix_timestamp) {
	const date = new Date(unix_timestamp);
	const nowDate = new Date(Date.now());
	
	const isSameDay = (date.getDate() === nowDate.getDate() 
				    && date.getMonth() === nowDate.getMonth()
				    && date.getFullYear() === nowDate.getFullYear())
				   
	if (isSameDay) {
		return "Today, " + date.toLocaleTimeString();
	}					
	
	return date.toLocaleString();
}

function setUpPersistanceTable() {
  $('#dt-persistence').DataTable({
	bLengthChange : true,
    bFilter : false,
	searching : false,
	order: [[0, 'desc']],
	paging: true,
	processing: true,
	responsive: true,
	stateSave: false,
    serverSide: true,
	  ajax: {
        url: '../HistoricalRecords/historyrecords',
        type: 'POST',
		data: function (d) {
            d.refId = {{featureId}};	 
			d.min = displayStartDate;
			d.max = displayEndDate;	 
        }
    },
	columnDefs: [
		{
			targets: 0,
			render: function (data, type, full, meta) {
				return humanizeTime(data);
			}
		},
		{
			targets: 1,
			render: function (data, type, full, meta) {
				return roundValue(data);
			}
		},
		{
			targets: 3,
			render: function (data, type, full, meta) {
				if (data === null) {
					return "";
				} else {
					return humanizeDuration(data * 1000);
				}
			}
		},
	],
	initComplete: function () {
	},
  });
  
  $(".dataTables_length").addClass("bs-select"); 
}

$(document).ready(function () {
	setUpPersistanceTable();
	$('#loading').hide();
});	

{{else if displaySelect=="chart"}}
	let chart;
 
	const colors = {
	  blue: {
		default: "#007bff",
		half: "rgba(00, 123, 233, 0.5)",
		quarter: "rgba(00, 123, 233, 0.25)",
		zero: "rgba(00, 123, 233, 0)"
	  }, 
	};
	
	const defaultTension = 0.1;
	
	function startFetchWithMinMax(chart, min, max) {
		console.log('Fetching data between ' + min + ' and ' + max);
		const formObject = {
		   refId : {{featureId}},
		   min: min,
		   max: max,
		   fill: chart.data.datasets[0].stepped ? 0 : 1,
		};
		
		ajaxPostPlugIn("graphrecords", formObject, function (result) {	 
			console.log('Fetched data between ' + min + ' and ' + max);
			chart.data.datasets[0].data =  result.data;
			chart.stop(); // make sure animations are not running
			chart.options.plugins.subtitle.text = getRangeString(min, max);
			
			if ((max - min) > (1000 * 60 * 60 * 24 * 2)) {
				chart.options.scales.x.time.displayFormats.hour = "MMM D";
			} else {
				chart.options.scales.x.time.displayFormats.hour = "hA";
			}
			
			if (result.groupedbyseconds == 0) {
				chartFunction(4);
			} else {
				chartFunction(3);
			}
			
			chart.update('none');		 
		});
	}
	
	function startFetch({chart}) {
	  const {min, max} = chart.scales.x;
	  startFetchWithMinMax(chart, min, max);
	}
		
	const zoomOptions = {
	  limits: {
		x: {min: 'original', max: 'original', minRange: 60 * 1000},
	  },
	  pan: {
		enabled: true,
		mode: 'x',
		modifierKey: 'ctrl',
		onPanComplete: startFetch
	  },
	  zoom: {
		wheel: {
		  enabled: true,
		},
		drag: {
		  enabled: true,
		},
		pinch: {
		  enabled: true
		},
		mode: 'x',
		onZoomComplete: startFetch
	  }
	};
	
	const scales = {
	  x: {
		position: 'bottom',
		min: displayStartDate,
		max: displayEndDate,
		time: {
			displayFormats: {
			  hour: "hA"
			},
		},
		type: 'time',
		ticks: {
		  autoSkip: true,
		  autoSkipPadding: 50,
		  maxRotation: 0
		},	
	  },
	  y: {
		type: 'linear',
		position: 'left',
		ticks: {
			callback: function(value, index, ticks) {
				return Chart.Ticks.formatters.numeric.apply(this, [value, index, ticks]) + '{{deviceUnits}}'
			}
        }
	  },
	};

	function setUpChart() { 
		Chart.defaults.font.family = "sans-serif";
		Chart.defaults.font.size = 16;
		
		let ctx = document.getElementById("myLineChart").getContext('2d'); 
		
		let gradient = ctx.createLinearGradient(0, 25, 0, 300);
		gradient.addColorStop(0, colors.blue.half);
		gradient.addColorStop(0.35, colors.blue.quarter);
		gradient.addColorStop(1, colors.blue.zero);


		let myChart = new Chart(ctx, {
		  type: "line",
		  data: {
				datasets: [{
					label: "Value",
					data: [],			 
					stepped : false,
					tension : defaultTension,
					pointStyle : false,
					fill: true,
					backgroundColor: gradient,
					pointBackgroundColor: colors.blue.default,
					borderColor: colors.blue.default,
					borderWidth: 2,
					pointRadius: 3
				}, 			 
			]
		  },
		  options: {
			scales: scales,
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
			    zoom: zoomOptions,
				legend: {
					display: false
				},	
			    subtitle: {
					display: true,
					text: '',
				}				
			},
			transitions: {
			  zoom: {
				animation: {
				  duration: 100
				}
			  }
			}
		  },  
		});
		 
		chart = myChart;
		startFetchWithMinMax(myChart, displayStartDate, displayEndDate);
	}
	
function chartFunction(reason) {
	switch(reason)
	{
		case 0:
		chart.resetZoom();
		break;
		case 1:
		chart.data.datasets[0].stepped = 'before';
		chart.data.datasets[0].tension = 0;
		chart.update();
		startFetch({chart});
		break;
		case 2:
		chart.data.datasets[0].stepped = false;
		chart.data.datasets[0].tension = defaultTension;
		chart.update();
		startFetch({chart});
		break;	
		case 3:
		chart.data.datasets[0].pointStyle = false;
		chart.update();
		break;	
		case 4:
		chart.data.datasets[0].pointStyle = 'circle';
		chart.update();	
		break;	
		case 5:
		chart.data.datasets[0].pointStyle = 'line';
		chart.update();
		break;
	}
}

$(document).ready(function () {
	setUpChart();
	$('#loading').hide();
});

{{else if displaySelect=="stats"}}

function setUpPersistanceTable() {
  $('#dt-persistence').dataTable({
	paging: false,
	responsive: true,
	bInfo : false, 
	ajax: function (data, callback, settings) {
		const formObject = {
		   refId : {{featureId}},
		   min: displayStartDate,
		   max: displayEndDate,   
		};

		ajaxPostPlugIn("statisticsforrecords", formObject, function (result) {	
		
			const unit={{if deviceUnits}}' {{deviceUnits}}'{{end}};
			const data= result["data"];
			const jsonResult =
			{
				data: [
					[	
					 "Average (Step)",
					 roundValue(data[0]).toString() + unit,
					],
					[	
					 "Average (Linear)",
					 roundValue(data[1]).toString() + unit,
					],
				]
			};			
			callback(jsonResult);
		});
	},
  });
  
  $(".dataTables_length").addClass("bs-select"); 
}

$(document).ready(function () {
	setUpPersistanceTable();
	$('#loading').hide();
});

{{else}}	
$(document).ready(function () {
	$('#loading').hide();
});
{{end}}

</script>
</body>
</html>
