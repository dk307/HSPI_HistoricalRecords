<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!--Don't cache anything-->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    {{includefile 'bootstrap/css/page_common.css'}}

    <title>History - Graphs</title>
	
    <style>
        canvas {
            width: 100% !important;
            object-fit: contain;
            margin: auto;
        }

        .chart-container {
            position: relative;
            margin: auto;
            height: 60vh;
        }
    </style>
</head>

{{
    graphid=queries['graphid']
    displayPeriod=queries['displayPeriod'] ?? ""
	
	customGraphs=plugin_function 'History' 'GetCustomGraphs'[]
	customGraphs=customGraphs ?? []
	
	# choose first graph if not set
	if !graphid && ((array.size customGraphs) > 0)
		graphid=customGraphs[0]["id"]
	end
	
	# find customGraphs in graphs
	customGraph=null
	for entry in customGraphs
		if (entry["id"] == (graphid | string.to_int))
			customGraph=entry
			break
		end
	end
	
	# invalid graphid passed, use first
	if !customGraph && ((array.size customGraphs) > 0)
		graphid=customGraphs[0]["id"]
		customGraph=customGraphs[0]
	end
	
	earliestRecordTimeSpan=0
	newestRecordTimeSpan=99999999
	
	
	units={}
	precision={}
	
	if customGraph
		for line in customGraph["lines"]
			devicePageStats=plugin_function 'History' 'GetDevicePageHeaderStats'[line.value["refId"]]
			devicePageStats=devicePageStats ?? [0,0,false,0,""]
			
			# find largest
			if (earliestRecordTimeSpan < devicePageStats[0])
				earliestRecordTimeSpan=devicePageStats[0] 
			end
			
			# find smallest
			if (newestRecordTimeSpan > devicePageStats[1])
				newestRecordTimeSpan=devicePageStats[1] 
			end
				
			units[line.value["refId"]]=devicePageStats[4] ?? ""
			precision[line.value["refId"]]=devicePageStats[3] 
		end
	end	

	
    rangeOptions=[]
    durationSeconds = ""
    if displaySelect != ""
        rangeOptionsForOthers=[
                         ["Last 6 hours", 21600, "6hr"],
                         ["Last 24 hours", 86400, "1d"],
                         ["Last 7 days", 604800, "7d"],
                         ["Last 30 days", 2592000, "30d"],
                         ["Last 90 days", 7776000, "90d"],
                         ["Last 180 days", 15552000, "180d"],
                         ["Last 365 days", 31536000, "365d"],
                     ]
        # Add range options less than oldest time stamp
        for rangeOption in rangeOptionsForOthers
            if  rangeOption[1] <= earliestRecordTimeSpan
                rangeOptions = rangeOptions | array.add rangeOption
            end
        end
		
        # add max
        maxRangeOption = ["Maximum", earliestRecordTimeSpan, "max"]
        rangeOptions = rangeOptions | array.add maxRangeOption
        rangeOptionFound = false
        for rangeOption in rangeOptions
            if rangeOption[2]==displayPeriod
                rangeOptionFound=true
                break
            end
        end
        if !rangeOptionFound
            # find the first option which would display some data
            for rangeOption in rangeOptions
                if rangeOption[1]>=newestRecordTimeSpan
                    displayPeriod=rangeOption[2]
                    rangeOptionFound=true
                    break
                end
            end
        end
        if !rangeOptionFound
            displayPeriod=rangeOptions[0][2]
        end
        for rangeOption in rangeOptions
            if  rangeOption[1] != "" && displayPeriod == rangeOption[2]
                durationSeconds=rangeOption[1]
                break
            end
        end
    end
    show_refId=(get_setting_bool 'gEnableDeviceRefColumn') == 'checked'	
	showEmpty = (array.size customGraphs) == 0
}}


<body class="body homeseer-skin">

  <!-- graphid={{graphid}}<BR> -->
  
    {{includefile 'header.html'}}
    {{includefile 'navbar.html'}}
    <div class="hs_spinner" id="loading">
        <div class="hs_spinner d-flex justify-content-center align-items-center align-content-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>

    <div class="container-fluid">
		{{if !showEmpty}}
		<header>
			<nav class="navbar">
				<form class="form-inline my-0 mx-0" id="mainform" action="/History/customgraphs.html" method="GET" style="width:100%">
					<div class="md-form my-0 mr-3 w-100">
						<select id="graphid" class="mdb-select md-form dropdown-primary colorful-select" name="graphid">
							{{for graph in customGraphs}}
							<option value="{{graph["id"]}}" {{if graph["id"]==graphid}} selected{{end}}>{{graph["name"] | html.escape}}</option>
							{{end}}
						</select>
						<label class="mdb-main-label" for="graphid">Graphs</label>
					</div>
					
					<div class="md-form my-0 mr-3">
						<select id="displayPeriod" class="mdb-select md-form colorful-select" name="displayPeriod">
							{{for rangeOption in rangeOptions}}
							<option value="{{rangeOption[2]}}" {{if rangeOption[2]==displayPeriod;}} selected{{end}}>{{rangeOption[0] | html.escape}}</option>
							{{end}}
						</select>
						<label class="mdb-main-label" for="displayPeriod">Period</label>
					</div>
					
					
					<ul class="navbar-nav ml-auto nav-flex-icons nav-right">
						<li class="nav-item">
							<a class="btn-floating btn-sm btn-default" data-toggle="modal" data-target="#add_graph_modal"><i class="fas fa-plus" data-toggle='tooltip' data-placement='top' title='Add new graph'></i></a>
						</li>
					</ul>
				</form>
			</nav>
		</header>

		<div class="text-center">
			<div class="btn-group mt-2 " role="group" aria-label="Graph options">
				<button type="button" class="btn btn-info" onclick="chartFunction(0)">Reset Zoom</button>

				<div class="btn-group" role="group">
					<button id="btnGroupDropCurve" type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Curve</button>
					<div class="dropdown-menu" aria-labelledby="btnGroupDrop1">
						<a class="dropdown-item" onclick="chartFunction(1)">Step</a>
						<a class="dropdown-item" onclick="chartFunction(2)">Linear</a>
					</div>
				</div>
				<button type="button" class="btn btn-info" onclick="showAddGraphLineModal()">Add device to graph</button>
			</div>
		</div>

		<table class="table table-sm table-striped" id="idLegand">
			<thead>
			<th scope="col"></th>
			<th scope="col"></th>
			<thead>
			<tbody></tbody>
		</table>
		
		
		<div class="chart-container mt-0">
			<canvas id="myLineChart"></canvas>
		</div>	
		<div class="mt-5 card" id="idNotDevicesInGraph" style="display:none">
		 <span class="text-center">The graph has no devices. Use Add device to graph button to add devices to graph.<span>
		</div>
		{{else}}
		<div class="card ml-3">
		 <span class="mt-2 ml-3">Add a new graph to get started<span>
		 <a class="btn-floating btn-sm btn-default" data-toggle="modal" data-target="#add_graph_modal"><i class="fas fa-plus" data-toggle='tooltip' data-placement='top' title='Add new graph'></i></a>	
		</div>
		{{end}}
    </div>
	
	
	<!-- add graph -->
	<div class="modal fade pg-show-modal" id="add_graph_modal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Add new graph</h4>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				</div>
				<form id="idGraphForm">
					<div class="modal-body">
						<input type="hidden" id="graph_id">
						<div class="md-form">
							<input type="text" id="graphName" class="form-control" name="graphName" required>
							<label for="graphName">Name</label>
						</div>					
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-cancel" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-success">Create</button>                    
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- add graph line -->
	<div class="modal fade pg-show-modal" id="add_graph_line_modal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Add device to graph</h4>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				</div>
				<form id="idGraphLineForm">
					<div class="modal-body">
						<input type="hidden" id="graphid">
						<div class="md-form">
							<select class='mdb-select md-form colorful-select' id='graphLineDevice' searchable="Search for a device here" required>
								<option value="" disabled="disabled" selected="selected">Select Device</option>
								{{	graphableRefIds = plugin_function 'History' 'GetDeviceListWithGraphAllowed' []}}
								{{ for id in graphableRefIds }}
								<option value='{{id}}'>{{device_name_full id true | html.escape}}{{if show_refId}}&nbsp;({{id}}){{end}}</option>
								{{ end }}
							</select>
						</div>					
						
						<div class="md-form">						
							<span>Color for graph line</span>
						</div>					
						<div class="md-form mt-1">						
							<div id="graph_line_color" class="mx-auto" name="graph_color"></div>
						</div>					
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-cancel" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-success">Create</button>                    
					</div>
				</form>
			</div>
		</div>
	</div>
	
	<BR>
	<BR>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    {{includefile 'bootstrap/js/page_common.js'}}
    <script type="text/javascript" src="/History/moment.min.js"></script>
    <script type="text/javascript" src="/History/history.common.js"></script>

    <script src="/History/chart.min.js"></script>
    <script src="/History/chartjs-adapter-moment.min.js"></script>
    <script src="/History/hammer.min.js"></script>
    <script src="/History/chartjs-plugin-zoom.min.js"></script>
    <script src="/History/chart.common.js"></script>
    <script>
	
	let chart;
	let colorPickerControl;
	let colorPickerControlValue = "#007bff";
	const colors = [
		"#007bff",
		"#38812F",
		"#005F60",
	];


	{{ if durationSeconds != "" }}
	const displayEndDate = 1000 * Math.round(Date.now() / 1000);
	const displayStartDate = Math.min(displayEndDate, displayEndDate + 1000 - {{durationSeconds}} * 1000);
	{{end}}


	function updateLegand() {
		let legandTableBody = $('#idLegand tbody');
		legandTableBody.empty();
		const items = chart.options.plugins.legend.labels.generateLabels(chart);

		items.forEach(item => {
			const td = document.createElement('td');
			td.style.alignItems = 'center';
			td.style.display = 'flex';
			td.style.flexDirection = 'row';
			td.style.marginLeft = '10px';

			// Color box
			const boxSpan = document.createElement('div');
			boxSpan.style.background = item.fillStyle;
			boxSpan.style.borderColor = item.strokeStyle;
			boxSpan.style.borderWidth = item.lineWidth + 'px';
			boxSpan.style.display = 'inline-block';
			boxSpan.style.flexShrink = 0;
			boxSpan.style.height = '20px';
			boxSpan.style.marginRight = '10px';
			boxSpan.style.width = '20px';

			// Text
			const textContainer = document.createElement('p');
			textContainer.style.color = item.fontColor;
			textContainer.style.margin = 0;
			textContainer.style.padding = 0;

			const text = document.createTextNode(item.text);
			textContainer.appendChild(text);

			td.appendChild(boxSpan);
			td.appendChild(textContainer);
			 			
			let row = $("<tr>");
			row.append(td);
			row.append($("<td>").html('<div style="float: right;">' + 
									   '<a class="fas fa-lg fa-point fa-sliders-h" data-mdb-toggle="tooltip" title="Change options" onclick="javascript:editGraph('+item.datasetIndex+')"></a>'+
									   '&nbsp;' +
									   '<a class="far fa-lg fa-point fa-trash-alt" data-mdb-toggle="tooltip" title="Remove from graph" onclick="javascript:deleteRecords('+item.datasetIndex+')"></a>'+
									   '</div>'));
			row.appendTo(legandTableBody);
		});
	}

	function setupLineChart() {
		{{if customGraph && ((array.size customGraph["lines"]) > 0)}}
		let ctx = document.getElementById("myLineChart").getContext('2d');
		
		chart = createLineChart(ctx, displayStartDate, displayEndDate);
		{{for line in customGraph["lines"]}}
		// {{line.value}}
		{{id = line.value["refId"]}}
		addDatasetToChart(chart, '{{line.value["lineColor"]}}', false, '{{line.value["lineColor"]}}', {{id}}, '{{units[id]}}', {{precision[id]}}, 
					     '{{device_name_full id true | html.escape}}{{if show_refId}} ({{id}}){{end}}');
		{{end}}

		for (let i = 0; i < chart.data.datasets.length; i++) {
			startFetchWithMinMax(chart, displayStartDate, displayEndDate, i);
		}

		chart.options.animation = {
			onComplete: function() {
				updateLegand();
			}
		};
		{{else}}
		$('#idLegand').hide();
		$('#myLineChart').parent().hide();
		$('#idNotDevicesInGraph').show();
		{{end}}
	}

	function initColorPicker() {
		
		colorPickerControl = new Pickr(
			{
				el: '#graph_line_color', 
				default: colorPickerControlValue,
				components: {
                    preview: true,
                    opacity: true,
                    hue: true,

                    interaction: {
                        hex: true,
                        rgba: true,
                        hsla: false,
                        hsva: false,
                        cmyk: false,
                        input: true,
                        clear: false,
                        save: true
                    }                
                },
				onSave(hsva) {
					colorPickerControlValue = hsva.toRGBA().toString();
                }
			}
		);
	}
	
	function hook() {

		$('#graphid').change(function() {
			this.form.submit();
		});

		$('#displayPeriod').change(function() {
			this.form.submit();
		});


	    $( "#idGraphForm").on("submit",async function (e) {
			e.preventDefault();
			

			const formObject = {
			   name: $('#graphName').val(),
			};
			const data = JSON.stringify(formObject);

			ajaxPostPlugIn("graphcreate", formObject, function (result) {		 
					graphid = result.id;
					window.location = "/History/customgraphs.html?graphid=" + graphid;
				}
			);
		});
		
	    $("#idGraphLineForm").on("submit",async function (e) {
			e.preventDefault();
			
			const formObject = {
			   graphid: {{graphid}},
			   refid: $('#graphLineDevice').val(),
			   linecolor: colorPickerControlValue,
			};
			const data = JSON.stringify(formObject);

			ajaxPostPlugIn("graphlinecreate", formObject, function (result) {		 
					graphid = result.id;
					window.location = "/History/customgraphs.html?graphid=" + graphid;
				}
			);
		});
	}
	
	function showAddGraphLineModal() {
		 $('#add_graph_line_modal').modal('show');
	}

	$(document).ready(function() {
		setupLineChart();
		initColorPicker();
		hook();
		$('#loading').hide();
	});
	</script>
</body>
</html>